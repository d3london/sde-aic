<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
    <meta charset="utf-8">
    <meta name="generator" content="quarto-1.4.553">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


    <title>London SDE/AIC Programme: Introduction and Proposed Use-Cases</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      ul.task-list{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        width: 0.8em;
        margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
        vertical-align: middle;
      }
    </style>

    <style>
      body.hypothesis-enabled #quarto-embed-header {
        padding-right: 36px;
      }

      #quarto-embed-header {
        height: 3em;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: solid 1px;
      }

      #quarto-embed-header h6 {
        font-size: 1.1em;
        padding-top: 0.6em;
        margin-left: 1em;
        margin-right: 1em;
        font-weight: 400;
      }

      #quarto-embed-header a.quarto-back-link,
      #quarto-embed-header a.quarto-download-embed {
        font-size: 0.8em;
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 1em;
        margin-right: 1em;
      }

      .quarto-back-container {
        padding-left: 0.5em;
        display: flex;
      }

      .headroom {
          will-change: transform;
          transition: transform 200ms linear;
      }

      .headroom--pinned {
          transform: translateY(0%);
      }

      .headroom--unpinned {
          transform: translateY(-100%);
      }      
    </style>

    <script>
    window.document.addEventListener("DOMContentLoaded", function () {

      var header = window.document.querySelector("#quarto-embed-header");
      const titleBannerEl = window.document.querySelector("body > #title-block-header");
      if (titleBannerEl) {
        titleBannerEl.style.paddingTop = header.clientHeight + "px";
      }
      const contentEl = window.document.getElementById('quarto-content');
      for (const child of contentEl.children) {
        child.style.paddingTop = header.clientHeight + "px";
        child.style.marginTop = "1em";
      }

      // Use the article root if the `back` call doesn't work. This isn't perfect
      // but should typically work
      window.quartoBackToArticle = () => {
        var currentUrl = window.location.href;
        window.history.back();
        setTimeout(() => {
            // if location was not changed in 100 ms, then there is no history back
            if(currentUrl === window.location.href){              
                // redirect to site root
                window.location.href = "index.html";
            }
        }, 100);
      }

      const headroom = new window.Headroom(header, {
        tolerance: 5,
        onPin: function () {
        },
        onUnpin: function () {
        },
      });
      headroom.init();
    });
    </script>

    
<script src="site_libs/manuscript-notebook/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
     <meta name="mermaid-theme" content="neutral">
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">  
      <meta name="citation_title" content="London SDE/AIC Programme: Introduction and Proposed Use-Cases">
<meta name="citation_author" content="Dr. Joe Zhang">
<meta name="citation_author" content="Prof. James Teo">
<meta name="citation_author" content="Jawad Chaudhry">
<meta name="citation_author" content="Dr. Jorge Cardoso">
<meta name="citation_author" content="Sigal Hachlili">
<meta name="citation_language" content="en">
</head>

  <body class="quarto-notebook">
    <div id="quarto-embed-header" class="headroom fixed-top bg-primary">
      
      <a onclick="window.quartoBackToArticle(); return false;" class="btn btn-primary quarto-back-link" href=""><i class="bi bi-caret-left"></i> Back to Article</a>
      <h6><i class="bi bi-journal-code"></i> Article Notebook</h6>

            <a href="./index.qmd" class="btn btn-primary quarto-download-embed" download="index.qmd">Download Source</a>
          </div>

     <header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">London SDE/AIC Programme: Introduction and Proposed Use-Cases</h1>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
            <div class="quarto-title-meta-author">
          <div class="quarto-title-meta-heading">Authors</div>
          <div class="quarto-title-meta-heading">Affiliation</div>
          
                <div class="quarto-title-meta-contents">
            <p class="author">Dr.&nbsp;Joe Zhang </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        London AI Centre / SDE
                      </p>
                  </div>
                      <div class="quarto-title-meta-contents">
            <p class="author">Prof.&nbsp;James Teo </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        London AI Centre / SDE
                      </p>
                  </div>
                      <div class="quarto-title-meta-contents">
            <p class="author">Jawad Chaudhry </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        London AI Centre / SDE
                      </p>
                  </div>
                      <div class="quarto-title-meta-contents">
            <p class="author">Dr.&nbsp;Jorge Cardoso </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        London AI Centre / SDE
                      </p>
                  </div>
                      <div class="quarto-title-meta-contents">
            <p class="author">Sigal Hachlili </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        London AI Centre / SDE
                      </p>
                  </div>
                    </div>
        
        <div class="quarto-title-meta">

                      
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>



    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#what-is-the-london-sde" id="toc-what-is-the-london-sde" class="nav-link" data-scroll-target="#what-is-the-london-sde">What is the London SDE?</a></li>
  <li><a href="#technology-and-objectives" id="toc-technology-and-objectives" class="nav-link" data-scroll-target="#technology-and-objectives">Technology and objectives</a></li>
  <li><a href="#proposed-use-cases" id="toc-proposed-use-cases" class="nav-link" data-scroll-target="#proposed-use-cases">Proposed use-cases</a>
  <ul class="collapse">
  <li><a href="#systematic-measurement-of-group-and-individual-health-inequality" id="toc-systematic-measurement-of-group-and-individual-health-inequality" class="nav-link" data-scroll-target="#systematic-measurement-of-group-and-individual-health-inequality">Systematic measurement of group and individual health inequality</a></li>
  <li><a href="#cardiovascular-disease-prevention-through-decision-intelligence" id="toc-cardiovascular-disease-prevention-through-decision-intelligence" class="nav-link" data-scroll-target="#cardiovascular-disease-prevention-through-decision-intelligence">Cardiovascular disease prevention through decision intelligence</a></li>
  <li><a href="#joining-up-cancer-pathways" id="toc-joining-up-cancer-pathways" class="nav-link" data-scroll-target="#joining-up-cancer-pathways">Joining up cancer pathways</a></li>
  </ul></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next steps</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">      

       <p><em>Version 1.0 (last updated May 3 2024)</em></p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The <a href="https://www.aicentre.co.uk/">London AI Centre</a> (AIC) has been commissioned as part of the London Secure Data Environment (SDE) programme for its latest phase: to extend AI technologies and analytics capabilities to stakeholders and data environments across London. This document summarises the latest state of planning for the programme, as an aid to internal and external stakeholders including Integrated Care Boards (ICB) and the wider London NHS ecosystem.</p>
</section>
<section id="what-is-the-london-sde" class="level2">
<h2 class="anchored" data-anchor-id="what-is-the-london-sde">What is the London SDE?</h2>
<p>The London Secure Data Environment (SDE) is part of a national programme to enable secure and more powerful analytics for NHS, academic, and commercial users. Uniquely amongst regional peers, the London SDE does not focus on a single research platform. Rather, it places a focus on developing data infrastructure and capabilities across the region to support population health, care providers, and commissioners. This is in addition to building data environments that enable commercial research and development partnerships.</p>
<p>The SDE is led by <strong>OneLondon</strong>, as part of an overarching London Health Data Strategy, coalescing around three components (<a href="#fig-sde-summary" class="quarto-xref">Figure&nbsp;1</a>):</p>
<ol type="1">
<li><p><strong>London Data Service (LDS)</strong>: hosted in North-East London, the LDS serves as a data engineering and service layer for pan-London primary care and secondary care data. It handles data extraction and linkage, and provisions data within secure analytics environments for both research and NHS users.</p></li>
<li><p><strong>DiscoverNOW Research/Analytics Environment</strong>: run by Imperial College Healthcare Partners in North-West London, DiscoverNOW supports governance and operation of secure research environments for academic, commercial, and NHS research and analytics.</p></li>
<li><p><strong>London AI Centre (AIC)</strong>: a national centre of excellence for applied data science and AI, the AIC provides frontier technology for data enrichment (CogStack), federated analytics (FLIP), and deployment of machine learning tools, as well as expertise in health data and advanced analytics.</p></li>
</ol>
<div class="cell-container"><div class="cell-decorator"><pre>In [1]:</pre></div><div class="cell" data-fig-width="6" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-sde-summary" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sde-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-sde-summary">flowchart TD
    d1[GP Surgeries] ==&gt;|Primary care data| LDS1[(London Data Service)]
    d2[NHS Digital] ==&gt;|Commissioning datasets| LDS1
    d3[Local data sources] ==&gt;|ICS data| ICB
    AIC1["CogStack in Trusts"] ==&gt;|"Unstructured data 
                                          (hospitals)
                                          via federation"| LDS1
    LDS1==&gt; AIC1a["CogStack in LDS"]
    AIC1a==&gt;|"Unstructured data 
                (primary care)"| LDS1
    LDS1 ==&gt;|Linked data| NWL1[("DiscoverNOW Research &amp; 
                                Analytics Environment")]

    AIC2["AIC FLIP"] ==&gt; |"Multi-modal data 
                                          (imaging metadata)
                                          via federation"| NWL1
    AIC2 ==&gt; |"Hospital cancer data
                via federation"| LDS1
    LDS1 ==&gt;|Linked data| ICB[("Integrated Care Board 'Sandpits' 
                                x5: NEL/SEL/SWL/NWL/NCL")]

    ICB &lt;==&gt;|Collaborative analytics| AIC3[AIC Data/AI Hub]
    ICB &lt;==&gt;|Output Sharing| LDS2[Terminology/Code/Model Servers]
    AIC3 &lt;==&gt;|Output Sharing| LDS2
    NWL1 &lt;==&gt;|Output Sharing| LDS2

    classDef green fill:#ab9, stroke:#333, stroke-width:1px
    classDef blue fill:#89c, stroke:#333, stroke-width:1px
    classDef bluegreen fill:#9ca, stroke:#333, stroke-width:1px
    classDef lightblue fill:#ace, stroke:#333, stroke-width:1px
    classDef red fill:#c89, stroke:#333, stroke-width:1px
    classDef lightorange fill:#ca8, stroke:#333, stroke-width:1px
    classDef orange fill:#d96, stroke:#333, stroke-width:1px
    classDef purple fill:#a9c, stroke:#333, stroke-width:1px
    classDef bluegray fill:#9ab, stroke:#333, stroke-width:1px
    classDef gray fill:#fff, stroke:#333, stroke-width:1px

    class LDS1,LDS2 blue
    class ICB lightblue
    class AIC1,AIC1a,AIC2,AIC3 orange
    class NWL1,NWL2 bluegray
    class d1,d2,d3 bluegreen
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sde-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Summary of SDE components and data flows. Each London ICB is provisioned with its own data/analytics environment through the LDS. FLIP = Federated Learning and Interoperability Platform.
</figcaption>
</figure>
</div>
</div>
</div></div>
</section>
<section id="technology-and-objectives" class="level2">
<h2 class="anchored" data-anchor-id="technology-and-objectives">Technology and objectives</h2>
<p>The contribution from the London AIC consists of technology deployment and supporting expertise, that enable a number of objectives (<a href="#fig-aic-objectives" class="quarto-xref">Figure&nbsp;2</a>) over the two year programme. This contribution includes the following:</p>
<ol type="1">
<li><p><strong>Federated Learning and Interoperability Platform (FLIP)</strong>: FLIP consists of (a) secure data environments within NHS hospital Trusts for multi-modal imaging data, imaging metadata, and structured health record data in the OMOP common data model; and (b) a mechanism to query data and train AI models across these secure enclaves without the need to physically transfer data. FLIP is presently installed in four major London Trusts. Integrating FLIP into the SDE will enable hospital data (such as cancer data) to be surfaced into the LDS, and enable access to multi-modal data (such as DICOM imaging and digital pathology) for research in precision medicine.</p></li>
<li><p><strong>CogStack</strong>: As an advanced natural language processing platform, CogStack can turn the large quantities of health information that are found in narrative text, into structured and analysable data. Currently actively used in Trusts to assist with clinical coding from notes and clinic letters, CogStack can surface secondary care and cancer pathway data, and previously unseen primary care data, into the SDE ecosystem.</p></li>
<li><p><strong>AIC Data/AI Hub</strong>: The AIC hosts health data and AI implementation expertise, that will provide practical support in analytics engineering, clinical informatics, data science, and machine learning (ML) development and deployment. Primary aims are to (a) help Integrated Care Boards (ICB) migrate data pipelines and analytics into common data models and terminologies within LDS environments; (b) extend these into reproducible pipelines for data science and predictive analytics deployment; and (c) work together to make ICBs self-sufficient in these capabilities. The AIC will also support the adoption and roll-out of the OMOP Common Data Model.</p></li>
</ol>
<div class="cell-container"><div class="cell-decorator"><pre>In [2]:</pre></div><div class="cell" data-fig-width="6" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-aic-objectives" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-aic-objectives-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-aic-objectives">flowchart LR
    FLIP["FLIP"] ==&gt; A1["Standardising hospital 
                          imaging metadata"] 
    FLIP ==&gt; A2[Technology installation]
    A1 ==&gt; A3["Federated model training
              for research collaborations"]
    A2 ==&gt; A3

    A2 ==&gt; A4["Enabling hospital 
              data queries"]
    B1 ==&gt; A4

    COG["CogStack"] ==&gt; B1["Standardising hospital 
                            cancer data"]
    COG ==&gt; B2[LDS installation] ==&gt; B3["Standardising primary care 
                                      unstructured data"]

    A4 ==&gt; C3
    B3 ==&gt; C3

    HUB[Data/AI Hub] ==&gt; C1["Assisting ICBs with migration 
                              of existing pipelines"]
    C1 ==&gt; C2["Building standardised 
                cohort pipelines"]
    C2 ==&gt; C3["Building reproducible analytics/ML 
              pipelines with sharable code base"]
    HUB ==&gt; C4["Working with LDS and EHR suppliers 
              to enable 'last mile' return of insights"]

    C4 ==&gt; C3

    HUB ==&gt; C5["Standardising London SDE data
                into OMOP common data model"]              
    
    C5 ==&gt; C2

    classDef yellow fill:#ed6, stroke:#333, stroke-width:1px
    classDef lightorange fill:#fb3, stroke:#333, stroke-width:1px
    classDef orange fill:#f81, stroke:#333, stroke-width:1px

    classDef yellowbase fill:#ed6, stroke:#333, stroke-width:4px
    classDef lightorangebase fill:#fb3, stroke:#333, stroke-width:4px
    classDef orangebase fill:#f81, stroke:#333, stroke-width:4px

    class FLIP yellowbase
    class A1,A2,A3,A4 yellow
    class COG lightorangebase
    class B1,B2,B3 lightorange
    class HUB orangebase
    class C1,C2,C3,C4,C5 orange
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-aic-objectives-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Summary of AIC work components and objectives. FLIP = Federated Learning and Interoperability Platform; ML = Machine Learning; EHR = Electronic Health Record
</figcaption>
</figure>
</div>
</div>
</div></div>
<p>As the LDS ICB environments share a common data model, any pipelines created in collaboration with one ICB can be adapted and used for any other ICB (or deployed across multiple environments to create pan-London insights). This will also facilitate the use of shared terminologies, and validating / versioning / serving NHS-owned machine learning models across regions.</p>
</section>
<section id="proposed-use-cases" class="level2">
<h2 class="anchored" data-anchor-id="proposed-use-cases">Proposed use-cases</h2>
<p>The following three use-cases are <em>examples</em> of analytics projects that can be supported within the SDE ecosystem, in collaboration between ICB/NHS analytics teams and the AIC/SDE team. Use-cases align to the London Health Data Strategy and long term condition priorities, as well as national programmes such as CORE20PLUS5, and are proposed here following early discussions with London ICBs. An objective for any work is to build upwards from a foundation of reproducible pipelines, towards data science and predictive analytics (<a href="#fig-general-framework" class="quarto-xref">Figure&nbsp;3</a>).</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [3]:</pre></div><div class="cell" data-fig-width="6" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-general-framework" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-general-framework-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-general-framework">flowchart BT
    A["Shared definitions of terminologies for
        LTC and supporting concepts"]

    B["Shared cohort building code with
        key subgroup stratification"]

    C["Multivariate adjusted insights
     and understanding of determinants"]
    
    D["Predictive analytics pathways 
    with decision support and evaluation"]
    
    A --&gt; B --&gt; C --&gt; D

    classDef gray fill:#fff, stroke:#333, stroke-width:1px

    class A,B,C,D gray
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-general-framework-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: General framework for use-cases: moving towards advanced analytics
</figcaption>
</figure>
</div>
</div>
</div></div>
<section id="systematic-measurement-of-group-and-individual-health-inequality" class="level3">
<h3 class="anchored" data-anchor-id="systematic-measurement-of-group-and-individual-health-inequality">Systematic measurement of group and individual health inequality</h3>
<p><strong>AIM:</strong> To systematically surface multiple dimensions of health inequality across sociodemographic / geospatial groups, and across individual patients, and to monitor this data continuously across key long-term conditions.</p>
<p><strong>SUMMARY:</strong> Health inequality refers to differences in health outcomes and determinants between individuals or groups (e.g.&nbsp;morbidity, co-morbidity, disease complications/death, healthcare access, disease screening, treatment delivery). The principle of health <em>equity</em> emphasises the recognition and reduction of disparities in determinants, resulting in more equal outcomes.</p>
<p>It is important to understand what groups suffer from health inequality. This is traditionally measured and visualised as a comparison of disease and outcome prevalence/incidence across different population groups. While helpful for broad insights, this also offers limited understanding of complex individual circumstances and determinants. This use-case proposes that measurement of inequalities can be extended to individual patients, by using clinical domain knowledge to define ‘indicators’ of unequal disease, diagnosis, and treatment pathways. In an individual with a long-term condition (LTC), example indicators of inequality are shown below. The contribution of individual indicators to later outcomes can also be measured in multivariate statistical models, and used to understand determinants for any given individual.</p>
<table class="table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td>1. LTC surfacing at an early age (<a href="#fig-onset-time" class="quarto-xref">Figure&nbsp;4</a>)</td>
</tr>
<tr class="even">
<td>2. LTC in proximity to relevant co-morbidities (e.g.&nbsp;cardiovascular risk factors)</td>
</tr>
<tr class="odd">
<td>3. Diagnosis at a <em>late</em> age but with more severe disease (e.g.&nbsp;in Diabetes, measured by HbA1c or presence of end-organ complications)</td>
</tr>
<tr class="even">
<td>4. Reduced health engagement/encounters/treatment compared to what is expected based on disease severity</td>
</tr>
<tr class="odd">
<td>5. Shorter time to complications and mortality following diagnosis</td>
</tr>
</tbody>
</table>
<p>The objective is to move beyond describing inequality, to understanding individual/small group determinants, and to increase actionability. At this level, determinants can be visualised for small specific groups, or individuals, with comparison to ‘what is expected’ in a background population.</p>
<div id="fig-onset-time" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-onset-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="media/onset_over_time.jpg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-onset-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Inequality in age of onset across demographic groups and deprivation, generated automatically through input of condition and group for stratification
</figcaption>
</figure>
</div>
<p>As per the framework described in (<a href="#fig-general-framework" class="quarto-xref">Figure&nbsp;3</a>), the initial stage of work will include defining shared terminologies, concepts, and indicators that cover LTC of interest. Secondly, existing descriptions of health inequality can be migrated onto the LDS environment, and extended such that any condition can be reproducibly visualised across multiple dimensions and ‘cuts’. This foundation can be further extended to encompass specific inequality indicators and statistical insights, at a small group and individual level, and the use of these insights to identify patients at greatest risk of health inequality, or those with addressable determinants.</p>
</section>
<section id="cardiovascular-disease-prevention-through-decision-intelligence" class="level3">
<h3 class="anchored" data-anchor-id="cardiovascular-disease-prevention-through-decision-intelligence">Cardiovascular disease prevention through decision intelligence</h3>
<p><strong>AIM:</strong> To enhance descriptive population health management with explainable predictive analytics and clinical guideline-based “decision intelligence” systems, across cardiovascular related co-morbidities (including hypertension, diabetes, chronic kidney disease).</p>
<p><strong>SUMMARY:</strong> The spectrum of cardiovascular long-term conditions (LTC) and associated risk factors is wide, and includes hypertension, diabetes, obesity, high cholesterol, ischaemic heart disease, stroke, and chronic kidney disease, as well as dementia, atrial fibrillation, and heart failure. The burden of such diseases is high. <a href="https://cks.nice.org.uk/topics/cvd-risk-assessment-management/background-information/burden-of-cvd/">Heart disease</a> alone causes a quarter of deaths in the UK, with direct costs to the healthcare system estimated at £9 billion by the British Heart Foundation. Cardiovascular disease is seen as a <a href="https://imperialcollegehealthpartners.com/portfolio/onelondon/">priority area for use of data</a> across OneLondon patient and public engagement.</p>
<div id="fig-icb-hypertension" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-icb-hypertension-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="media/example_dashboard.jpg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-icb-hypertension-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Existing ICB dashboard for Hypertension
</figcaption>
</figure>
</div>
<p>In London ICBs, there is robust aggregate understanding of LTC, through prevalence reporting and Quality Outcome Framework (QOF) indicators. Existing ICB dashboards (<a href="#fig-icb-hypertension" class="quarto-xref">Figure&nbsp;5</a>) show how a practice or a system are performing relative to their peers. However, such reporting has limitations, including: (1) lack of adjustment for demographics and other confounding variables; (2) difficulty in surfacing individual patients with direct actions; and (3) lack of consideration of complex co-morbidity phenotypes. This last is particularly important, as multi-morbidity changes the risk profile and urgency of response for individuals. Some of these limitations are being addressed by existing work in London pathfinder programmes, and in other regions such as Greater Manchester, which are moving towards electronic identification of patients who may be actioned via pre-agreed clinical pathways (<a href="#fig-simple-pathway-action" class="quarto-xref">Figure&nbsp;6</a>).</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [4]:</pre></div><div class="cell" data-fig-width="6" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-simple-pathway-action" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simple-pathway-action-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-simple-pathway-action">flowchart LR
    A["Patient has CKD, 
      but is not on a Statin"] ==&gt; A1["Assess and consider 
                                        starting a Statin"]

    B["HbA1c high in two consecutive years,
      but patient not identified as Diabetic"] ==&gt; B1["Code for Diabetes, and invite
                                                    for clinical assessment and education"]

    C["Patient has Hypertension and Diabetes, 
      is on BB (where ACEi is recommended)"] ==&gt; C1["Assess and consider 
                                                      medication switch"]


    classDef white fill:#fff, stroke:#333, stroke-width:1px
    classDef gray fill:#eee, stroke:#333, stroke-width:1px

    class A,B,C white
    class A1,B1,C1 gray
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simple-pathway-action-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Examples of simple logical triggers leading to clinical actions. CKD = Chronic Kidney Disease; BB = Beta-blocker; ACEi = ACE inhibitor.
</figcaption>
</figure>
</div>
</div>
</div></div>
<p>These limitations can be surmounted through using richer data to generate personalised risk profiles for individual patients (rather than aggregate group summaries). A previous collaboration between the AIC and North-East London ICB was able to develop precise cardiovascular risk prediction models for individuals, using explainable machine learning algorithms and the linked patient health record. Actionable factors could also be highlighted in patients with high risk, with their relative importance explained through statistical modelling to enhance explainability (<a href="#fig-htn-actionable" class="quarto-xref">Figure&nbsp;7</a>).</p>
<div id="fig-htn-actionable" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-htn-actionable-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="media/htn_actionable.jpg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-htn-actionable-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Actionable factors (including follow-up, treatment, blood pressure control) and association of features with adverse outcome in high risk hypertensive patients
</figcaption>
</figure>
</div>
<p>Predictive analytics alone are not a solution. Patients identified as “high risk” may have few clinical factors that can be optimised, and non-specific risk stratification is known to lead to <a href="https://bmjopen.bmj.com/content/9/6/e026470">increased resource utilisation without improving outcomes</a>. Instead, this use-case proposes the use of validated clinical guidelines and domain knowledge to identify specific optimisation or preventative actions - much like <a href="#fig-simple-pathway-action" class="quarto-xref">Figure&nbsp;6</a>, but systematically, and on a larger scale. The combination of predictive analytics and explicitly defined actions to support decisions, is known as <a href="https://www.gartner.com/en/information-technology/glossary/decision-intelligence">“decision intelligence”</a>.</p>
<p>This use-case will again first develop shared terminologies, features, and code to enhance current pipelines and dashboards (<a href="#fig-general-framework" class="quarto-xref">Figure&nbsp;3</a>). This is an opportunity for using new programme capabiltiies to extend existing work through:</p>
<table class="table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td>(1) Using CogStack to extract additional valuable context and missing codes from unstructured text to improve performance, and reduce potential for negative biases, in predictive models;</td>
</tr>
<tr class="even">
<td>(2) Computerising Quality Outcomes Framework targets and clinical guidelines, in conjunction with local clinical teams, to develop safe decision logic for use as part of an effector arm;</td>
</tr>
<tr class="odd">
<td>(3) Using rich features in the EHR to develop statistical and machine learning models for predicting and understanding risk of progression and acute care utilisation across cardiovascular morbidity and co-morbidity;</td>
</tr>
<tr class="even">
<td>(4) For a given patient’s health record, understanding actions (i.e.&nbsp;are there actions available, and what are they), combined with explainable risks across multiple conditions (i.e.&nbsp;what are the highest risks for this patient and why), to support decision-making;</td>
</tr>
<tr class="odd">
<td>(5) Returning individual patient insights and suggested actions to clinical systems such as EHR (EMIS) or the London Care Record</td>
</tr>
</tbody>
</table>
<p>Highly individualised patient profiles are the objective of personalised care, and are a key component of preventative healthcare. Any deployed systems will need to be evaluated and monitored for safety and fairness, with a process of training and handover to continuity teams following the end of this SDE programme phase. This is the objective of on-going work by responsible AI and AI governance teams in the AI Centre.</p>
</section>
<section id="joining-up-cancer-pathways" class="level3">
<h3 class="anchored" data-anchor-id="joining-up-cancer-pathways">Joining up cancer pathways</h3>
<p><strong>AIM:</strong> To link cancer pathways (including screening, diagnosis, staging, and outcomes) across primary care and secondary care. To identify areas of inequality in screening and late diagnosis, and to generate predictive insights for risk and screening recall.</p>
<p><strong>SUMMARY:</strong> Cancer has long been a challenging area for data-driven initiatives. Primary care coding of cancer is often incomplete, as the majority of care following referral takes place in hospitals. The most readily available secondary care data is from Commissioning Data Sets, which are only complete for inpatient care, and may not include the majority of cancer events. Within hospitals, the largest quantity of cancer data sits within audit datasets, or within unstructured text and clinic letters, which are not easily accessible.</p>
<p>This results in significant limitations. First, it is difficult to reconcile screening data with diagnostic outcomes. Second, only an incomplete picture of cancer diagnoses can be obtained at the ICB level, including of disease severity following delayed referral or prolonged waiting time. Finally, it is difficult to gain understanding of how such pathways impact on overall treatment outcomes and cancer recurrence.</p>
<p>The SDE programme provides opportunities to surface and link currently missing data, to provide an end-to-end overview of key cancer pathways. <a href="#fig-sde-summary" class="quarto-xref">Figure&nbsp;1</a> has been adapted below to show cancer data flows within the SDE ecosystem (<a href="#fig-cancer-data" class="quarto-xref">Figure&nbsp;8</a>). This work is complementary to additional work with FLIP to make cancer imaging and digital pathology data available, to support precision medicine research in the same patient cohorts.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [5]:</pre></div><div class="cell" data-fig-width="6" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-cancer-data" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cancer-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-cancer-data">flowchart TD
    d1[GP Surgeries] ==&gt;|"Primary care
                        coded cancer data"| LDS1[(London Data Service)]
    d2[NHS Digital] ==&gt;|"National Disease
                      Registration Service"| LDS1
    AIC1["CogStack in Trusts"] ==&gt;|"Cancer staging, diagnosis,
                                      from unstructured text"| AIC2
    LDS1 ==&gt; AIC1a["CogStack in LDS"]

    AIC1a ==&gt; |"Cancer presentation, symptoms,
              from unstructured GP text"| LDS1

    d3[Hospital Trusts] ==&gt;|"Cancer registry and 
                            audit datasets"| AIC2

    AIC2["AIC FLIP"] ==&gt; |"Hospital cancer data
                          via federation"| LDS1
    
    LDS1 ==&gt;|"Linked cancer data
            and federated analytics"| ICB[("ICB / AIC Analytics Teams")]

    classDef green fill:#ab9, stroke:#333, stroke-width:1px
    classDef blue fill:#89c, stroke:#333, stroke-width:1px
    classDef bluegreen fill:#9ca, stroke:#333, stroke-width:1px
    classDef lightblue fill:#ace, stroke:#333, stroke-width:1px
    classDef red fill:#c89, stroke:#333, stroke-width:1px
    classDef lightorange fill:#ca8, stroke:#333, stroke-width:1px
    classDef orange fill:#d96, stroke:#333, stroke-width:1px
    classDef purple fill:#a9c, stroke:#333, stroke-width:1px
    classDef bluegray fill:#9ab, stroke:#333, stroke-width:1px
    classDef gray fill:#fff, stroke:#333, stroke-width:1px

    class LDS1 blue
    class ICB lightblue
    class AIC1,AIC1a,AIC2,AIC3 orange
    class d1,d2,d3 bluegreen
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cancer-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Summary of cancer data flows within the London SDE ecosystem.
</figcaption>
</figure>
</div>
</div>
</div></div>
<p>It is expected that year one of the programme will consist of infrastructural work to enable these data flows, with a focus on two cancer areas, <strong>breast cancer</strong> and <strong>lung cancer</strong>. This work will include the installation of technology such as CogStack and FLIP, and creating pipelines to standardise data into OMOP to enable linked querying and federated analytics. Year two will enable a number of analyses for each cancer area that can support understanding of population health, health inequalities, and pathway bottlenecks, and ultimately support the use of predictive analytics to address late referrals, missed screening, and late diagnosis.</p>
<table class="table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td>(1) How common is later stage cancer diagnosis following primary care referral, and what is the incidence/prevalence of late diagnosis across different patient groups and geographies?</td>
</tr>
<tr class="even">
<td>(2) Which patient groups are most subject to screening delay or refusal, and what is the impact on late cancer diagnoses?</td>
</tr>
<tr class="odd">
<td>(3) In a typical longitudinal cancer “journey” (including screening/GP presentation with symptoms -&gt; referral/investigation -&gt; diagnosis -&gt; treatment initation), where are the major delays? Is there inequality in how patient groups are affected by delays?</td>
</tr>
<tr class="even">
<td>(4) Can the unstructured and structured GP record be used to inform cancer risk and referrals through predictive analytics?</td>
</tr>
<tr class="odd">
<td>(5) Can population groups with cancer outcomes inequality be targeted to increase early diagnosis rates?</td>
</tr>
</tbody>
</table>
<p>Ultimately, a major aim of this SDE programme phase is to bring cancer data availability, linkage, and utilisation in line with other long-term conditions, and to enable systematic evaluation across the entire cancer pathway.</p>
</section>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next steps</h2>
<p>This phase of the London SDE programme commenced in April 2024, along the roadmap described in <a href="#fig-aic-objectives" class="quarto-xref">Figure&nbsp;2</a>. With each ICB having their own requirements, objectives, and timelines, the AIC Data/AI Hub has been commissioned to support ‘as much’ or ‘as little’ as required: initially to help with standardisation of terminologies and cohort definitions, and eventually to help create a code base and model library that can be shared and re-used across the London region. It is also the intention to help pass on specific technical expertise and other practices to ICB teams, to enable continuity following the end of the programme.</p>
</section>
     </main>
<!-- /main column -->  <script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>  </div> <!-- /content --> 
  
</body></html>